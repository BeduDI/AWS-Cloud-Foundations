# Seguridad a nivel de cuenta

Al generar una cuenta de AWS se genera con una cuenta root, es una cuenta administradora que tiene por defecto acceso a todos los servicios con todos los permisos en cada uno.

- La primera recomendación es asegurar la cuenta con un MFA (milti factor authentication).
- La siguiente es no utilizar la cuenta root para hacer operaciones BAU (business as usual) del día a día, es mejor generar un usuario con permisos limitados a lo necesario para administrar la cuenta, así si llega a ser comprometida los daños pueden ser menores.
- Se debe establecer una política de seguridad acorde a la organización, habilitando longitudes mínimas, tipos de caracteres que deben contener las contraseñas, políticas de vencimiento para renovación de la contraseña, prohibir la reutilización contraseñas, todo ello ayudará a que la cuenta no sea comprometida.
- Al acceder a los servicios por medio del AWS SDK o AWS CLI no se recomienda embeber las credenciales de acceso en la aplicación, en su lugar se deben usar los roles de AWS para delegar permisos a las aplicaciones.

# Shared Responsibility Model

AWS comparte junto con los administradores de las cuentas la responsabilidad de mantener las aplicaciones funcionando correctamente.

AWS se compromete a mantener la infraestructura funcionando, las redes, discos duros, electricidad, enlaces de baja latencia, hypervisores, etc. Por parte de los administradores de una cuenta AWS recae el cifrado de archivos en transferencia y reposo, parche de sistemas operativos, backups, segregación de permisos, gestión de cuentas. El ejemplo más icónico es una instancia EC2, la instancia debe ser manejada por el administrador, el administrador configura quién tiene acceso a qué puertos de la instancia, cuanto storage se le provisionará, que sistema operativo tendrá, a qué red o redes y con qué otras instancias se podrá comunicar, en qué zona de disponibilidad esta la instancia ejecutándose, el cifrado de datos también es importante.

![https://d1.awsstatic.com/security-center/Shared_Responsibility_Model_V2.59d1eccec334b366627e9295b304202faf7b899b.jpg](https://d1.awsstatic.com/security-center/Shared_Responsibility_Model_V2.59d1eccec334b366627e9295b304202faf7b899b.jpg)

# Autenticación y autorización

- AWS Directory Service
Tradicionalmente en entornos Windows el producto estrella para temas de autenticación y autorización es Windows Active Directory.
Microsoft Active Directory es un servicio que permite guardar objetos de tipo usuario, equipos (hosts) y grupos para administrar el acceso y autenticación a una red.
Para poder iniciar sesión en la red es necesario que el host se una al dominio previamente con ayuda de un administrador de Active directory, una ve hecho eso un usuario que también debe estar dado de alta en el dominio puede iniciar sesión.
Active Directory es una pieza delicada en la infraestructura si el servicio falla o se pierde se pierde acceso prácticamente a todas las aplicaciones y servicios que requieran autenticación y autorización. 
Amazon ha lanzado un servicio de Active Directory administrado (PaaS), AWS se encarga de desplegar el dominio
en 2 zonas de disponibilidad, configura la replicación, gestiona parches de seguridad de los Controladores de dominio (un controlador de dominio es donde se hostea Active Directory).

El siguiente es un esquema típico de AWS Active Directory

![ad](https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/10/22/standardedition_usecases_1017_large.png)

- AWS Identity and Access Management (IAM)

- AWS Organizations
AWS Organizations nos permite agrupar varias cuentas de AWS en una única cuenta administradora, así las empresas que brindan servicios pueden tener a su cargo las cuentas de sus cliente con sus propias políticas de control de servicio (SCP) que dictan cuales son los permisos máximos en los en la organización.
Las Unidades Unidades Organizacionales (OU) junto con las Cuentas (Accounts) son las piezas claves que hacen de las organizaciones una herramienta poderosa en cuanto a la gestión se refiere. La función de la OU es agrupar Accounts, las OU pueden tener dentro otras OU con otras Accounts, a cada OU se le puede asociar una SCP para regular los permisos de los usuarios a la organización.

![organizaciones](https://docs.aws.amazon.com/organizations/latest/userguide/images/BasicOrganization.png)


- AWS Single Sign-On
Es posible brindar acceso a cuentas de AWS por medio de AWS Organizations sin tener que usar cuentas que distintas a las que ya se utilizan en un Active Directory empresarial. El entorno Active DIrectory por medio de AWS Single Sign-On puede extenderse para brindar acceso ademas de cuentas de AWS  a servicios como Gsuite, Dropbox, Office 365, Slack, Github, Salesforce, Jira, Zendesk por mencionar algunos.
AWS Single Sign-On es un proveedor de identidad ([IdP](https://www.cloudflare.com/learning/access-management/what-is-an-identity-provider/)),  compatible con el estándar SAML encargado de proveer credenciales de autorización a los proveedores de servicios (a las aplicaciones como Slack o GSuite).
La mejora en seguridad aumenta, cuando un usuario final tiene que recordar o manejar varias claves para distintas herramientas que usan tienden a usar la misma clave o en el peor de los casos escribirla y dejarla a la vista de cualquiera. Un servicio unificado de autenticación  con acceso a otras herramientas hace la vida más fácil, recuerda y maneja una única contraseña.
![qq](https://d2908q01vomqb2.cloudfront.net/22d200f8670dbdb3e253a90eee5098477c95c23d/2017/12/07/AM_AWSSSOUseCases_120717a.png)

# Identidad y gestión de usuarios
El proceso de identificación, autenticación y autorización a personas, aplicaciones y sistemas es critica para garantizar seguridad en cualquier organización.
Establecer y gestionar las funciones y privilegios de acceso de los usuarios de la red debe proporcionar a los administradores las herramientas y tecnologías para realizar un seguimiento de las actividades del usuario y para hacer cumplir las políticas de seguridad continuamente.
En el campo de TI a este proceso se le conoce como `Identity and access management` (AWS tomó el término y lo hizo un producto no hay que confundirlos).


# Amazon Identity and Access Management (IAM)
Es el pilar de la seguridad en AWS ya que administra el acceso a servicios y recursos de AWS.
Prácticamente es un servicio omnipresente, estará en cualquier servicio u aplicación que despleguemos en la nube no importanto si es muy pequeña o muy grande.
IAM nos permite definir permisos a niveles muy granulares lo que da mucha flexibilidad a la hora de definir quien puede acceder y que puede hacer en los recursos que definamos.
IAM soporta la estrategia de autorización Attribute-based access control (ABAC) por medio de TAGS en los recursos, con lo que podemos definir políticas de acceso o denegacion a un servicio basados
solo en la etiqueta que pongamos en nuestros recursos.
También soporta la estrategia de autorización role-based access control (RBAC). podemos definir permisos (policies) en este caso a los usuarios mismos que creemos en AWS.
Siempre debemos garantizar que las cuentas que acceden a los recursos cumplan con en principio de mínimo privilegio



# Amazon Cognito
AWS Cognito permite conceder acceso a recursos de AWS a nuestros usuarios por medio de la generación de tokens por medio de terceros.

![cognito](https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2017/06/18/CognitoDiagram.png)


Al momento de configurar un pool de usuarios de Cognito (un pool es una configuración dada de autenticación) es posible especificar quien será el proveedor de servicios de autenticación, si es Facebook por ejemplo se debe especificar el [Facebook AppID](https://webkul.com/blog/how-to-generate-facebook-app-id/) para que Cognito confíe en los tokens que esta app mandará. Una vez autenticado Cognito verificará los niveles de acceso apropiados generando un token temporal para poder acceder al recurso de AWS dado.
![cognito-tool](cognito.png)

# Amazon Inspector

Amazon inspector nos permite verificar las vulnerabilidades en las instancias EC2. Las vulnerabilidades que pueden ser detectadas tienen que ver con las prácticas de redes que se están implementando por ejemplo el número de puertos abiertos a nuestras instancias, también es posible verificar vulnerabilidades dentro del host o instancia, para lo cual Amazon inspector debe instalar un agente (software) en la instancia que estará haciendo el análisis y reportando a Inspector sobre las vulnerabilidades halladas. Se pueden definir las instancias que deseamos mantener vigiladas por medio de TAGS, hay que tener cuidado, por default selecciona todas las instancias que se tengan en la región lo que puede resultar en costos un tanto elevados, es importante configurar la periodicidad con la que el agente escaneara por vulnerabilidades para no elevar demasiado los costos.
En el dashboard podemos ver los reportes en formato PDF, es un reporte muy completo, explica cada vulnerabilidad, la severidad y una posible solución a cada vulnerabilidad.

![inspector](inspector.png)

# Arquitecturas para recuperación a desastres\*

Cuando todo va mal, desastres naturales, ataques de ramsomware, o simplemente un empleado enojado borra información deliberadamente, cada uno de esos escenarios son escenarios que solo en las peores pesadillas pasan, pero también pasan en la vida real, aqui no hay que preguntarse si pasará, si no cuando pasará. 
Dicho eso la arquitectura de las aplicaciones deben estar orientadas para ser fuertes ante ataques o accidentes.
En AWS hay 5 pilares fundamentales para cumplir. Seguridad, flexibilidad, excelencia operativa, eficiencia de rendimiento y optimización de costos. En la práctica dos conceptos moldean mucha de la arquitectura con capacidad de recuperación de desastres, son el RTO y el RPO.
El RTO (Recovery Time Object) es el tiempo que tarda en el caso de un desastre en reconfigurar todo y volver a operar, dependiendo la aplicación puede ir desde minutos hasta días.
El RPO (Recovery Point Object) dicta cual es la cantidad de datos que tenemos oportunidad de perder sin que afecte substancialmente al negocio, dependiendo del giro es posible perder varios registros pero en aplicaciones bancarias, ¿te imaginas que se perdieran transacciones?, en ese caso el RPO debe ser muy pequeño, incluso al orden de segundos.
El RTO indica la rapidez con la que se requiere recuperarse de un tiempo sin servicio, mientras el RPO define la frecuencia con la que se necesitan hacer copias de seguridad.
AWS nos dará la flexibilidad necesaria para disminuir el RPO y el RTO. Backups de instancias EC2 se pueden hacer directamente en el servidor y al final transferir los archivos a un bucket S3, otra posibilidad es utilizar Snapshots de la maquina virtual con intervalos de tiempo definidos, si sucede algo podemos volver a la ultima versión de la instancia EC2, indudablemente la replicacion y acomodo de las aplicaciones en servidores en distintas zonas de disponibilidad ayudará a la hora de recuperación, la ultima estrategia podría llegar a tener un RTO muy pequeño en infraestructuras complejas al tener replicada la infraestructura en distintas zonas de disponibilidad listas para entrar a operar si asi se requiriera. Otra tendencia que puede reducir el RTO es la llamada IaaC (Infrastructure as a Code), en AWS nos valemos de AWS CLoud Formation para definir infraestructuras completas con redes ocnfiguradas, instancias de distintos tamaños, balanceadores de cargas, roles, etc en un solo archivo de definicion. Literal tareas que pueden llevar semanas tradicionalmente con Cloud Formation se pueden aprovisionar infraestructuras completas en horas. En Bases de datos RDS, AWS también brinda mecanismos de respaldo automatizados basados en snapshots de la instancia RDS, en caso de un problema se puede regresar al ultimo snapshot disponible.


# Protección de infraestructura a ataques\*

Hay métodos de protección a infraestructura generales agnósticos de la nube que usemos que ayudarán a mejorar y disminuir la probabilidad de algún ataque informático.

Parches de seguridad a servidores:
El software se encuentra en constante evolución, y el sistema operativo no es la excepción, con el paso del tiempo se van encontrando vulnerabilidades en los sistemas operativos que un atacante puede utilizar para vulnerar nuestras aplicaciones.
AWS Systems Manager nos ayudará con el proceso de aplicación de parches, # TODO prueba de concepto patch manager

Hardening de servidores:
Al tener un servicio ejecutándose es necesario asegurarse de contar con buenas prácticas para mantener todo el software que usemos seguro, ya que muchas veces los sistemas operativos o servicios que instalemos como Postgres no se instala por default con las mejores prácticas de seguridad. Un ejemplo es hacer hardering a un servidor [Nginx](https://www.acunetix.com/blog/web-security-zone/hardening-nginx/).

Principio de mínimos permisos:
Es necesario no ejecutar las aplicaciones, bases de datos, servidores web y sistema operativo por mencionar algunos con credenciales que no sean root, en el caso de base de datos por ejemplo se recomienda crear un usuario con permisos restringidos para no eliminar una base de datos o crear nuevos usuarios.
En el caso de las instancias de EC2 se debe tener cuidado con la llave de acceso al servidor no se vea comprometida, en caso de ser comprometida se tiene que seguir un proceso difícil y lento, básicamente implica generar una nueva instancias de EC2 y mover el disco duro (EBS ) de la vieja instancia a la nueva instancia.
A nivel de Nube es necesario establecer políticas y roles con mínimos permisos, por ejemplo, si creamos un bucket S3 para que una aplicación lo consuma se debe restringir el acceso solo a ese bucket con el permiso de solo lectura.

Listas de acceso y denegación por IP:
En el nivel de red es necesario proveer las direcciones IPS a nuestros firewalls que no debe dejar pasar o que permita el paso, también se recomienda restringir los puertos abiertos.
Una política de acceso restringido da buenos resultados en la práctica, se establece en firewall que ninguna ip sea permitida y se pueden ir agregando las IP permitidas poco a poco.
En AWS podemos lograr este control configurando ACLs y Security Groups en la sección VPC.

Monitoreo:
¿Cómo sabremos si nos están atacando? Siempre debemos contar con logs que capten evidencia de toda la actividad que nuestras aplicaciones tienen. También es importante monitorear los "signos vitales" de los servidores como la Memoria RAM, uso de red, uso de CPU, con lo que podemos tener pistas al ver comportamientos anómalos, ej: se incrementa el uso de red considerablemente en una hora en la madrugada desde una IP específica, eso ya podría darnos una señal de alarma.
CloudWatch de AWS nos permite recolectar toda esta información con la posibilidad de establecer alarmas para dar aviso a administradores y personal de DevOps no limitándose a solo instancias EC2 si no a otros servicios críticos como Amazon RDS, DynamoDB, incluso es posible monitorear logs dentro de los sistemas operativos, para tal tenemos que instalar CloudWatch Agent, un software que enviará una copia del log o los logs que deseamos monitorear centralizadamente, aún podemos ir mas allá, es posible monitorear sistemas on premise con el agente. Ya con los logs en Cloud Watch es posible configurar alarmas que notifiquen ante actividad sospechosa. 


# Despliegue de soluciones predefinidas (marketplace)

Miles de soluciones de software al alcance de pocos clicks, ¿requieres un servidor Wordpress?, ¿que tal un servidor Django?, ¿un SQL Server en Windows? y ¿que hay de un Citrix?. Pues estas y miles de aplicaciones listas para ser desplegadas, lo mejor, es posible escoger el tamaño de instancia EC2 donde queremos que funcionen.
Empresas como ZOHO Corporation Private Limited ,ADARA Inc.,Aviatrix Systems, Inc.,CloudGuard Dome9, Cloud Compliance,F5 Networks ,OpenVPN Inc.,Unisys Corporation,Pyxsoft PowerWAF,Citrix ,Hyperglance, A10 Networks,aiScaler,Cisco ,Kemp Technologies,Tyk Technologies Ltd,MapR Technologies, Cloud Infrastructure Services ,Radware, DataSunrise Database and Data Security,Symantec, NGINX ,Sophos,SANGFOR,AppEx Networks, Barracuda Networks ,IXIA,Juniper Networks,Cisco Stealthwatch Cloud, Fortinet Inc. ,MEGAZONECLOUD Corporation, IBM Security, Edgenexus,Pulse Secure LLC, 9STAR, Palo Alto Networks, netCUBED,ADEO Imaging, Cognosys Inc.,TrueStack,Lumeta, a Firemon Company, BT Diamond IP, Zscaler, Aurora,Cohesive Networks, Array Networks, TurnKey GNU/Linux,Bricata,Mphasis ponen al alcance sus productos listos para desplegar en la infraestructura AWS, en términos de licenciamiento ya dependerá de los términos y condiciones de cada herramienta, hay soluciones que ya traen los costos de las licencias incluidos en el costo por hora de instancia, por el contrario, hay soluciones donde debes adquirir una licencia con la marca o un proveedor, licencia que tiene un costo independiente a lo que son las horas de instancia de EC2.
AWS también te da la posibilidad de vender soluciones por medio de AWS marketplace, generando tus propias Amazon Machine Images (AMI) pueden ser puestas a disposición en el marketplace para que otros las puedan consumir.

# Web application firewall

AWS WAF
Un WAF es un elemento capaz de evitar ataques a nuestra infraestructura y aplicaciones. ¿Como lo logra?, monitorea el tráfico http y en base a patrones específicos, listas de direcciones IP, payloads específicos, cabeceras, localización, numero request por segundo,  tiene la capacidad de deducir un ataque. Ejemplo: SQL Injection, este tipo de ataques se hacen poniendo parámetros muy específicos en la URL como `https://insecure-website.com/products?category=Gifts'+OR+1=1--` donde `+OR+1=1` es la parte añadida maliciosa a la URL en búsqueda de un acceso no autorizado.
Con AWS podemos integrar un WAF a nuestros balanceadores de carga rápidamente pues ya se cuenta con un conjunto de reglas de seguridad con patrones específicos de ataque por direcciones IP, ataques a sistemas operativos, ataques a aplicaciones PHP, ataques a sitios WordPRess, patrones que cumplen OWASP y si eso no es suficiente por medio del Marketplace se pueden adquirir soluciones mas complejas con fabricantes reconocidos en la industria como [F5 Networks](https://aws.amazon.com/marketplace/pp/B0779MPHVH).

AWS Shield
En sus 2 capas de servicio ofrece el servicio para detección y protección ante ataques de denegación de servicio (DDoS). Ofrece 2 capas, la primera es la Standard solo se tiene el monitoreo de flujo y protección básica a DDoS, la otra es la capa Advanced (con costo de $3000 USD/mes) ofrece además detección y mitigación a medida,  detección en múltiples capas, reportes y analítica, soporte 24/7, servicio AWS WAF y AWS Firewall Manager sin costo adicional principalmente. 


# Protección de datos en tránsito

AWS Certificate Manager: Aquí podemos generar certificados SSL/TLS para nuestros dominios, asegurando que el tráfico en la red esté cifrado, los certificados pueden ser usados por AWS Load Balancer, Amazon CloudFront y API Gateway, en general solo funciona con soluciones de tipo PaaS, si requerimos un certificado TLS para ponerlo dentro de una instancia EC2 no es posible, ya que Amazon no te da la opción de descargar estos certificados. Por ellos a la hora de trabajar con ellos por por ejemplo en cloud front, simplemente aparecerá una Dropdown donde escogerás los distintos certificados que tengas disponibles. Para generar los certificados debes primero comprobar que eres el administrador del dominio que deseas usar certificado, esto se logra agregando un registro en el DNS o por medio del envío de un email a administrator@your_domain_name, hostmaster@your_domain_name, postmaster@your_domain_name, webmaster@your_domain_name, admin@your_domain_name.
![certificate-manager](certificate-manager.png)


# Protección de datos en reposo

- AWS CloudTrail  TODO: Desarrollarla

- Amazon Macie
Tener un bucket  de S3 nos brinda mucha flexibilidad a la hora de guardar archivos, es un servicio con una capacidad de almacenamiento enorme y de precios muy reducidos lo que lo hace un servicio muy socorrido. ¿Sabemos cuáles son nuestros activos almacenados en ese bucket?, con facilidad puede llegar el punto en que es inmanejable la cantidad de información almacenada lo que hará imposible revisar que la información no sea sensible o si lo es que estemos conscientes de ello.
Macie es una herramienta que escanea por nosotros cada bucket en búsqueda de información sensible y nos brindará un reporte con las observaciones que encuentre.

![macie](macie.png)
![macie2](macie2.png)
![macie3](macie3.png)


- Key Management Service (KMS)
Aquí se pueden gestionar llaves criptográficas de cifrado simétrico y asimétrico, ya sea generadas por mismo AWS o se pueden importar claves propias en el caso de ser requerido.
Hay una lista extensa de servicios con los que KMS puede integrarse dentro del ecosistema de Amazon para flexibilidad y facilidad del administrador, por citar algunos tenemos a Amazon Relational Database Service (RDS), Amazon S3, Amazon CloudWatch Logs, Amazon Glacier ,Amazon Simple Notification Service (SNS), Amazon Simple Queue Service (Amazon SQS), Amazon EBS, AWS Storage Gateway entre los más representativos. Muchas veces el tema de cifrado se da por temas regulatorios o de certificaciones (por ejemplo PCI) para algunos tipos de datos te exigen tener estándares de cifrado. Se recomienda como en todo servicio de AWS revisar bien el esquema de precios y como este impactará en la solución.

- AWS Cloud HSM
Módulo de seguridad de hardware (HSM) administrado en la nube de AWS, tradicionalmente los HSM son hardware que se usa en organizaciones para proteger claves criptográficas. Están especialmente diseñados para ser eficientes matemáticamente ante los cálculos que involucra el cifrado, descifrado firma y comprobación de firmas que los algoritmos exigen. Es Hardware especialmente diseñado para ser resistentes a modificaciones de hardware no autorizadas. La solución de AWS es poner a disposición un HSM como PaaS para facilidad de uso, el inconveniente para muchos es el precio, pues por un mes de uso ronda en alrededor a Septiembre del 2020 en unos 22,606 MXN al mes.


- AWS Security Hub
Puedes tener reportes sobre el estado del cumplimiento de mejores prácticas de seguridad para cumplir con PCI DSS v3.2.1, escaneo para cumplimiento de las prácticas recomendadas de seguridad v1.0.0 fundamentales de AWS, y cumplimiento de indicadores de referencia v1.2.0 de CIS para AWS. Después de Habilitar Security Hub se tiene un reporte con las observaciones listas para poder ser parchadas.

![aws-hub](aws-hub.png)
